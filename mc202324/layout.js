
layout = [
  { 
    _id: 0,
    _lyt: [
      "                      xxxxxxxxxxxxxxxxxxx",
      "                      x                 x",
      "                      x x x kkkkkkkkkkk x",
      "                      x x               x",
      "                      x x x kkkkkkkkkkk x",
      "                      x x x             x",
      "                      x x x kkkkkkkkkkk x",
      "                      x2x x             x",
      "                      xxx x kkkkkkkkkkk x",
      "                        x x             x",
      "                        x x   tthehtt   x",
      "                        x xxxxxxxxxxxxxxx",
      "                        x x m  m  m  m  x",
      "                        x w    gg gg gg x",
      "                        x w gg gg gg gg x",
      "                        x w gg gg gg gg x",
      "                        x w gg gg gg gg x",
      "                        x w gg gg gg gg x",
      "                        x w             x",
      "                        x w m  m  m  m  x",
      "                        x w             x",
      "                        x w gg gg gg gg x",
      "xxxxxxxxx               x w gg gg gg gg x",
      "x  ee  cx               x w gg gg gg gg x",
      "xl    ctxxxxxxxxxxxx    x w gg gg gg gg x",
      "xl    ctx           xx  x w    gg gg gg x",
      "x      cx xxxxxxxxx   xxx xwwwwwwwwwwwwwx",
      "xxxx xxxx     x    xx                   x",
      "x  x ll x   x1x      xxxxxxxxxxxxxxxxxxxx",
      "xl x        xxxxx                        ",
      "x       x       x                        ",
      "xxxx    xpaax llx                        ",
      "x     llxxxxx llx                        ",
      "xll   llx t x   x                        ",
      "xll     xc cx llx                        ",
      "x     llxc cx llx                        ",
      "xll   llxxx x   x                        ",
      "xll           llx                        ",
      "xi      xxx x llx                        ",
      "xll  ll xzf x   x                        ",
      "xll  ll x   xxxxx                        ",
      "x    ll xa  x                            ",
      "xxxxxxxxxxxxx                            "
    ],
    _dir: {
      '1': 'down',
      '2': 'up'
    }
  }, 
  {
    _id: 1,
    _lyt: [
      "  xxx                 ",
      "  x xxxxxxxxxx        ",
      "  x x   ee   x        ",
      "  x x c    c x        ",
      "  x   c    c x        ",
      "  x x c    c x        ",
      "xxx x c    c x        ",
      "x0  x cccccc x        ",
      "xxx x        x        ",
      "  x xxxxxxxxxxxxxxxxxx",
      "  x                  x", 
      "  xxxxxxxxxxxxxxxxx  x",
      "  xgggggggggg  w  x  x",
      "  x            w  x  x",
      "  xgg gg gg gg w     x",
      "  xgg gg gg gg w     x",
      "  x            w  x  x",
      "  xgggggggggg  w  x  x",
      "  xxxxxxxxxxxxxxxxxxxx"
    ],
    _dir: {
      '0': 'up'
    }
  },
  {
    _id: 2,
    _lyt: [
      "xxxxxxxxxxxxxxxxxxxxx",
      "x0x x  x c   bb     x",
      "x x x  xc    xxxxxxxx",
      "x x x  xc           x",
      "x x x  x c          x",
      "x   x  xxxxxxxxxxx  x",
      "x   x            x  x",
      "x      xZxBxCxDx x  x",
      "x      xXxXx3x4x x  x",
      "xxxxxxxxxxxxxxxxxxddx",
    ],
    _dir: {
      '0': 'down',
      '3': 'up',
      '4': 'up'
    }
  },
  {
    _id: 3,
    _lyt: [
      "xxxxxxxxxxxxxxxxxxxxxxx      ",
      "x x   x   cc cc cc cc x      ",
      "x x x x               x      ",
      "x x2x x   cc cc cc cc x      ",
      "x xxx xx xxxxxxxxxxxxxx      ",
      "x   x        x cccccc x      ",
      "x   x          kkkkkk x      ",
      "x   x xxxxxxxx        x      ",
      "x   x x      x kkkkkk x      ",
      "x   x x      x cccccc x      ",
      "yyyyy xxxxxxxxxxxxxxxxxyyyyyy",
      "y                           y",
      "y c c    cccc  cc           y",
      "y c c                       y",
      "y        cccc  cc           y",
      "y c c                       y",
      "y c c    c c   cc           y",
      "y        c c            c c y",
      "y c c    c c   cc       c c y",
      "y c c    c c            c c y",
      "y                           y",
      "xxxxx xxxxxxx xxxxxxxxxxxxxxx",
      "xa    x tet x x ctc  x  ctc x",
      "xf    x kkk x x $c?  x  ccc x",
      "xa   ax kkk x xxxxx xx xxxxxx",
      "xa   zx ccc            x tt x",
      "xxxxxxxxxxxxx xxxxxxxx x cc x",
      "xlll lll ll   x      x   cc x",
      "x                   lx xxxxxx",
      "xlll lll ll   xa    lx x #! x",
      "x             xt     x   kktx",
      "xlll lll ll   xxxxxxxx x ?c x",
      "x             x4       xxxxxx",
      "xxxxxxxxxxxxx xxxxxxx       x",
      "xll ll ll ll   ll ll   ll llx",
      "x                           x",
      "x                           x",
      "xll ll ll ll   ll ll   ll llx",
      "xxxxxxxxxxxx  xxxxxxx xxxxxxx",
      "x     taaapx  xl a lx xp  llx",
      "xl         x  x     x       x",
      "xaa  cccc     x       xa    x",
      "xxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
    ],
    _dir: {
      '2': 'down',
      '4': 'up'
    }
  },
  {
    _id: 4,
    _lyt: [
      "                             ",
      "                             ",
      "                             ",
      "                             ",
      "xxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
      "x                           x",
      "x      jjj   jjjj   jjj     x",
      "x      j j   j  j   j j     x",
      "x      jjj   jjjj   jjj     x",
      "x                           x",
      "xxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
      "x                           x",
      "x   r r                     x",
      "x   r r                     x",
      "x        r                  x",
      "x                           x",
      "xxxxxxx xxxxxxxxxxxxxxxxxxxxx",
      "xm x                     xm x",
      "xm x          xxxxx      xm x",
      "xm x          xmmmx      xm x",
      "xm x          xxxxx      xm x",
      "xm x                     xm x",
      "xxxx          xxxxx      xxxx",
      "x2B           xm mx         y",
      "xxxx          xm mx         y",
      "x3C           xm mx         y",
      "xxxx          xxxxx      xxxx",
      "xm x                     xm x",
      "xm x          xxxxx      xm x",
      "xm x          xmmmx      xm x",
      "xm x          xxxxx      xm x",
      "xm x                     xm x",
      "xxxxxxxxxxxKURAGARIxxxxxxxxxx",
      "x                           x",
      "x      jjj   jjjj   jjj     x",
      "x      j j   j  j   j j     x",
      "x      jjj   jjjj   jjj     x",
      "x                           x",
      "xxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
      "                             ",
      "                             ",
      "                             ",
      "                             "
    ],
    _dir: {
      '2': 'down',
      '3': 'down'
    }
  }
]

const get_pos_of_link = ( layout, n ) => {
  n = n.toString()
  for( var ii = 0; ii < layout.length; ii++ ) {
    for( var jj = 0; jj < layout[ 0 ].length; jj ++ ) {
      if( layout[ ii ][ jj ] == n ) {
        return [ true, ii, jj ]
      }
    }
  }
  return [ false, 0, 0 ]
}

const map_symbols = ( x ) => {
  if( is_digit( x ) ) return { type: 'link', to: parseInt( x ), symbol: 'â˜¢ï¸' }
    
  if( x == 'a' ) return { type: 'layout', symbol: 'ðŸ—„ï¸' }
  if( x == 'b' ) return { type: 'layout', symbol: 'ðŸ“¦' }
  if( x == 'c' ) return { type: 'deco',   symbol: 'ðŸª‘' }
  if( x == 'd' ) return { type: 'deco',   symbol: 'ðŸšª' }
  if( x == 'e' ) return { type: 'deco',   symbol: 'ðŸ“ˆ' }
  if( x == 'f' ) return { type: 'layout', symbol: 'â˜•' }
  if( x == 'g' ) return { type: 'layout', symbol: 'ðŸ§®' }
  if( x == 'h' ) return { type: 'deco',   symbol: 'ðŸ“Š' }
  if( x == 'j' ) return { type: 'layout', symbol: 'ðŸŸ©' }
  if( x == 'k' ) return { type: 'deco',   symbol: 'ðŸ“–' }
  if( x == 'l' ) return { type: 'layout', symbol: 'ðŸ–¥ï¸' }
  if( x == 'm' ) return { type: 'layout', symbol: 'ðŸª­' }
  if( x == 'p' ) return { type: 'layout', symbol: 'ðŸ–¨ï¸' }
  if( x == 'r' ) return { type: 'layout', symbol: 'ðŸ¦Œ' }
  if( x == 's' ) return { type: 'deco',   symbol: 'ðŸªœ' }
  if( x == 't' ) return { type: 'layout', symbol: 'ðŸ“º' }
  if( x == 'w' ) return { type: 'layout', symbol: 'ðŸªŸ' }
  if( x == 'x' ) return { type: 'layout', symbol: 'â¬›' }
  if( x == 'y' ) return { type: 'layout', symbol: 'ðŸŸ¦' }
  if( x == 'z' ) return { type: 'layout', symbol: 'â„ï¸' }
  
  if( x == 'Z' ) return { type: 'deco',   symbol: '0ï¸âƒ£' }
  if( x == 'B' ) return { type: 'deco',   symbol: '1ï¸âƒ£' }
  if( x == 'C' ) return { type: 'deco',   symbol: '2ï¸âƒ£' }
  if( x == 'D' ) return { type: 'deco',   symbol: '3ï¸âƒ£' }
  if( x == 'W' ) return { type: 'layout', symbol: 'â¬œï¸' }
  if( x == 'X' ) return { type: 'layout', symbol: 'âŒ' }
  
  if( x == 'K' ) return { type: 'deco',   symbol: 'ðŸ…š' } // 'ðŸ‡°' }ðŸ… ðŸ…‘ ðŸ…’ ðŸ…“ ðŸ…” ðŸ…• ðŸ…– ðŸ…— ðŸ…˜ ðŸ…™ ðŸ…š ðŸ…› ðŸ…œ ðŸ… ðŸ…ž ðŸ…Ÿ ðŸ…  ðŸ…¡ ðŸ…¢ ðŸ…£ ðŸ…¤ ðŸ…¥ ðŸ…¦ ðŸ…§ ðŸ…¨ ðŸ…©
  if( x == 'U' ) return { type: 'deco',   symbol: 'ðŸ…¤' } // 'ðŸ‡º' }
  if( x == 'R' ) return { type: 'deco',   symbol: 'ðŸ…¡' } // 'ðŸ‡·' }
  if( x == 'A' ) return { type: 'deco',   symbol: 'ðŸ…' } // 'ðŸ‡¦' }
  if( x == 'G' ) return { type: 'deco',   symbol: 'ðŸ…–' } // 'ðŸ‡¬' }
  if( x == 'I' ) return { type: 'deco',   symbol: 'ðŸ…˜' } // 'ðŸ‡®' }
  
  if( x == 'mrs' ) return { type: 'interact', symbol: 'ðŸŽ…' }
  if( x == 'dnt' ) return { type: 'interact', symbol: 'ðŸ©' }
  if( x == 'mrr' ) return { type: 'interact', symbol: 'ðŸ¦Œ' }
  if( x == 'mss' ) return { type: 'interact', symbol: 'ðŸ¤¶' }
  if( x == 'pmk' ) return { type: 'interact', symbol: 'ðŸŽƒ' }
  if( x == 'phn' ) return { type: 'interact', symbol: 'ðŸ‘»' }
  if( x == 'trl' ) return { type: 'interact', symbol: 'ðŸ§Œ' }
  if( x == 'snw' ) return { type: 'interact', symbol: 'â›„' }
  if( x == 'bel' ) return { type: 'interact', symbol: 'ðŸ””' }
  if( x == 'tre' ) return { type: 'interact', symbol: 'ðŸŽ„' }
  if( x == 'prs' ) return { type: 'interact', symbol: 'ðŸŽ' }
  if( x == 'str' ) return { type: 'interact', symbol: 'ðŸŒŸ' }
  if( x == 'sle' ) return { type: 'interact', symbol: 'ðŸ›·' }
  
  if( x == 'Â¡' ) return{ type: 'interact', symbol: 'ðŸ§œâ€â™€ï¸' }
  if( x == 'Â¿' ) return{ type: 'interact', symbol: 'ðŸ§œ' }
  if( x == '@' ) return{ type: 'interact', symbol: 'ðŸ§œâ€â™‚ï¸' }
  if( x == '!' ) return{ type: 'interact', symbol: 'ðŸ§šâ€â™€ï¸' }
  if( x == '?' ) return{ type: 'interact', symbol: 'ðŸ§š' }
  if( x == '#' ) return{ type: 'interact', symbol: 'ðŸ§šâ€â™‚ï¸' }
  if( x == '$' ) return{ type: 'interact', symbol: 'ðŸ§žâ€â™€ï¸' }
  if( x == '%' ) return{ type: 'interact', symbol: 'ðŸ§žâ€â™‚ï¸' }
  if( x == '&' ) return{ type: 'interact', symbol: 'ðŸ§ž' }
  
  
  // ðŸ—ƒ
  // ðŸ‘¹ ðŸ‘º ðŸ¤¡ ðŸ’© 
  // ðŸŸ¥ ðŸŸ§ ðŸŸ¨  ðŸŸª ðŸŸ«
  // â„ï¸
  // ðŸ§ ðŸ§â€â™€ï¸  ðŸ§â€â™‚ï¸ 
  // 
  if( x == 'up' )    { return { 'type': 'deco', symbol: 'â¬†ï¸' } }
  if( x == 'down' )  { return { 'type': 'deco', symbol: 'â¬‡ï¸' } }
  if( x == 'right' ) { return { 'type': 'deco', symbol: 'âž¡ï¸' } }
  if( x == 'left' )  { return { 'type': 'deco', symbol: 'â¬…ï¸' } }
  return { type: 'no-layout' }
}

const is_digit = ( x ) => {
  return ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'].indexOf( x ) !== -1
}

const get_initial_player = ( x ) => {
  if( x !== undefined ) {
    for( var ii = 0; ii < x.length; ii++ ) {
      for( var jj = 0; jj < x[ 0 ].length; jj++ ) {
        if( x[ ii ][ jj ] == 'i' ) {
          return [ true, ii, jj ]
        }
      }
    }
  }
  return [ false, -1, -1 ]
}



class ViewPoint {
  constructor( wsz ) {
    this._wsz = wsz
  }
  
  get_window( player, layout, objects_matrix ) {
    var rst = []
    var uii = player._x - this._wsz / 2
    var ujj = player._y - this._wsz / 2
    for( var ii = uii; ii < player._x + this._wsz / 2; ii++ ) {
      rst[ ii - uii ] = []
      for( var jj = ujj; jj < player._y + this._wsz / 2; jj++ ) {
        if( ii >= 0 && jj >= 0 && ii < layout._lyt.length && jj < layout._lyt[ 0 ].length ) {
          if( objects_matrix[ ii ][ jj ] != '' ) {
            rst[ ii - uii ].push( objects_matrix[ ii ][ jj ] ) 
          } else {
            rst[ ii - uii ].push( layout._lyt[ ii ][ jj ] )
          }
        } else {
          rst[ ii - uii ].push( ' ' )
        }
      }
    }
    return [ new Map1( rst, layout._dir ), new Player( this._wsz / 2, this._wsz / 2 ) ]
  }
}

class Map1 {
  constructor( layout, dir ) {
    this._layout = layout
    this._dir = dir
  }
  
  draw( ox, oy, sz ) {
    let szi = sz + 2
    let szj = sz + 1
    for( var ii = 0; ii < this._layout.length; ii++ ) {
      for( var jj = 0; jj < this._layout[ 0 ].length; jj++ ) {
          textSize( sz )
          var tkn = map_symbols( this._layout[ ii ][ jj ] )
          if( tkn.type != 'no-layout') {
            text( tkn.symbol, ox + szj * jj, oy + szi * ( ii + 1 ) )
          }
        if( tkn.type == 'link' ) {
          var rtkn = map_symbols( this._dir[ tkn.to ] )
          text( rtkn.symbol, ox + szj * jj, oy + szi * ( ii + 1 ) )
        }
      }
    }
  }
}