<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>A New Christmas Card</title>
  <style>
    * { padding: 0; margin: 0; }
    canvas { background: #eee; display: block; margin: 0 auto; }
  </style>
</head>
<body>
  <canvas id="myCanvas" width="800" height="600"></canvas>
  <script>
    var canvas = document.getElementById("myCanvas")
    var context = canvas.getContext("2d")
    var width = 800;
    var height = 600;
    /* ----------------------------------------------------------------- */
    var app_color = '#eeeeee'

    function getColor(char, dft) {
      switch(char) {
        case 'b':
          return('#993333')
        case 'w':
          return('#FFFFFF')
        case 'G':
          return('#404040')
        case '#':
          return(dft)
        default:
          return('red')
      }
    }
    /* ----------------------------------------------------------------- */
    class Map {
      constructor(x, y) {
        this.x = x
        this.y = y
        this.width = 350
        this.height = 25
        this.current = null
        this.draw_travel_menu = true
        this.draw_search_menu = true
        this.travel_options = null
        this.search_options = null
        this.img = null
        this.info_show = [
          ['13px Arial', 'black', 'NO INFO FOR AGENT']
        ]
      }

      addItem(item) {
        this[item.id] = item
      }

      move(new_id) {
        console.log('move to: ' + new_id)
        this.current = new_id
        this.create()
      }

      _create_travel() {
        this.travel_options = new Menu(this.x, this.y, this[this.current].connections.map( (it) => {
          return new MenuOption( this[it].city + ' (' + this[it].country + ')' )
        }))

        for(let ii = 0; ii < this[this.current].connections.length; ii++) {
          let move_to = this[this.current].connections[ii]
          this.travel_options.addPulse(ii, function() {
            moveLocation(move_to)
          })
        }

        this.travel_options.setVertical()
        this.travel_options.hideTitle()
        this.travel_options.setBoxSize(this.width, this.height, 8, 4)

        this.img = new Image()
        this.img.src = this[this.current].img

        this.toggleDrawTravel()
      }

      _create_search() {
        this.search_options = new Menu(this.x, this.y, this[this.current].locations.map( (it) => {
          return new MenuOption( it.name )
        }))
        
        for(let ii = 0; ii < this[this.current].locations.length; ii++) {
          let text_show = this[this.current].locations[ii].desc
          this.search_options.addPulse(ii, function() {
            showSearchOption(text_show)
          })
        }

        this.search_options.setVertical()
        this.search_options.hideTitle()
        this.search_options.setBoxSize(this.width, this.height, 8, 4)

        //this.toggleDrawSearch()
      }

      create() {
        this._create_travel()
        this._create_search()
      }

      toggleDrawTravel() {
        this.draw_travel_menu = !this.draw_travel_menu
        this.draw_search_menu = false
      }

      toggleDrawSearch() {
        this.draw_travel_menu = false
        this.draw_search_menu = !this.draw_search_menu 
      }

      draw(ctx) {
        if(this.draw_travel_menu) {
          this.travel_options.draw(ctx)
        }

        if(this.draw_search_menu) {
          this.search_options.draw(ctx)
        }
      }

      checkButtons(x, y, ctx) {
        if(this.draw_travel_menu) {
          this.travel_options.checkButtons(x, y, ctx)
        }
      }

      drawLandscape(x, y, ctx) {
        // Box for picture
        ctx.fillStyle = 'black'
        if(this.img != null) {
          ctx.drawImage(this.img, x, y)
        } else {
          ctx.fillRect(x, y, 600, 350)
        }
        // Box for information
        ctx.fillRect(620, y, 160, 350)
        ctx.fillStyle = 'lightgray'
        ctx.fillRect(621, y + 1, 158, 348)

        // Default text
        ctx.font = '13px Arial';
        ctx.fillStyle = 'black'
        ctx.fillText('Your current location is:', 630, y + 15)
        ctx.font = '15px Arial';
        ctx.fillText(this[this.current].city, 630, y + 30)

        // Location information
        let accum_y = y + 70
        this.info_show.forEach( (line) => {
          ctx.font = line[0];
          ctx.fillStyle = line[1]
          ctx.fillText(line[2], 630, accum_y)
          accum_y += 15
        })
      }
    }
    /* ----------------------------------------------------------------- */
    class TimeTraker {
      constructor(x, y, days, slots, width) {
        this.x = x
        this.y = y
        this.allowed_days = days;
        this.used_days = 0
        this.allowed_slots = slots
        this.used_slots = 0
        this.width = width
        this.offset_x = 8
        this.width = (this.width - this.offset_x * (this.allowed_slots - 2)) / this.allowed_slots
        this.height = 10
      }

      addTime() {
        this.used_days += 1
        this.used_slots = Math.floor(this.used_days * this.allowed_slots / this.allowed_days )
      }

      draw(current, ctx) {
        ctx.font = "12px Arial";
        ctx.fillStyle = 'black'
        ctx.fillText('Time tracker ' + '.'.repeat(192), this.x, this.y - 3)


        let iterative_x = this.x
        for(let ii = 0; ii < this.allowed_slots; ii++) {
          ctx.fillStyle = 'black'
          ctx.fillRect(iterative_x - 1, this.y - 1, this.width + 2, this.height + 2)
          if(ii < this.used_slots) {
            ctx.fillStyle = 'pink'
          } else {
            ctx.fillStyle = 'lightgray'
          }
          ctx.fillRect(iterative_x, this.y, this.width, this.height)

          iterative_x += this.width + this.offset_x
        }
      }
    }

    /* ----------------------------------------------------------------- */
    class MenuOption {
      constructor(text, picture) {
        this.text = text
        this.picture = picture
        this.x = null
        this.y = null
      }

      setCoordinates(x, y) {
        this.x = x
        this.y = y
      }

      _drawPicture(ctx, dft, w) {
        let sz = 4
        let row = 0
        let col = 0
        let px = this.x + (w / 2) - (6 * sz / 2)
        let py = this.y + 30
        this.picture.forEach( (it) => {
          ctx.fillStyle = getColor(it, dft)
          let x = px + sz * row
          let y = py + sz * col
          ctx.fillRect(x, y, sz, sz)

          col += 1
          if(col % 6 == 0) {
            col = 0
            row += 1
          }
        })
      }

      draw(ctx, px, w, h, draw_picture) {
        ctx.font = px + "px Courier New";
        ctx.fillStyle = 'black'
        ctx.fillRect(this.x, this.y, w, h)
        ctx.fillStyle = 'lightgray'
        ctx.fillRect(this.x + 1, this.y + 1, w - 2, h - 2)
        ctx.fillStyle = 'black'
        
        let tx = this.x + (w / 2) - (ctx.measureText(this.text).width / 2)

        ctx.fillText(this.text, tx, this.y + px + 2)

        if(draw_picture) {
          if(this.picture !== undefined) {
            this._drawPicture(ctx, 'lightgray', w)
          }
        }
      }

      clicked(x, y, w, h) {
        let test_x = x > this.x & x < this.x + w
        let test_y = y > this.y & y < this.y + h
        //console.log('(', x, ', ', y, ') -> (', this.x, ', ', this.y, ', ', this.x + w, ', ', this.y + h, ') -> ', test_x, ' / ', test_y)
        return test_x & test_y
      }
    }

    class Menu {
      constructor(x, y, options) {
        this.x = x
        this.y = y
        this.width = 125
        this.height = 75
        this.options = options
        this.offset_x = 8
        this.offset_y = 4
        this.px = 15
        this.orientation = 'horizontal'
        this.show_title = true
        this.pulse = []
      }

      setVertical() {
        this.orientation = 'vertical'
      }

      setHorizontal() {
        this.orientation = 'horizontal'
      }

      showTitle() {
        this.show_title = true
      }

      hideTitle() {
        this.show_title = false
      }

      setBoxSize(w, h, ox, oy) {
        this.width = w
        this.height = h
        this.offset_x = ox
        this.offset_y = oy
      }

      draw(ctx) {
        if(this.show_title) {
          ctx.font = "12px Arial";
          ctx.fillStyle = 'black'
          ctx.fillText('Menu ' + '.'.repeat(112), this.x, this.y - 3)
        }

        if(this.orientation == 'horizontal') {
          let iterative_x = this.x
          for(let ii = 0; ii < this.options.length; ii++) {
            this.options[ii].setCoordinates(iterative_x, this.y)
            this.options[ii].draw(ctx, this.px, this.width, this.height, true)
            let txt = this.options[ii].text
            
            iterative_x += this.width + this.offset_x * 2
          }
        } else { // 'vertical'
          let iterative_y = this.y
          for(let ii = 0; ii < this.options.length; ii++) {
            //console.log(this.x, iterative_y)
            this.options[ii].setCoordinates(this.x, iterative_y)
            this.options[ii].draw(ctx, this.px, this.width, this.height, false)
            let txt = this.options[ii].text
            
            iterative_y += this.height + this.offset_y * 2
          }
        }
      }

      addPulse(pos, fun) {
        this.pulse[pos] = fun
      }

      checkButtons(x, y, ctx) {
        let pos = this.options.map( (it) => it.clicked(x, y, this.width, this.height) )
        pos = pos.indexOf(1)
        if(pos != -1) {
            this.pulse[pos](ctx)
        }
      }
    }
    /* ----------------------------------------------------------------- */
    function create_map(x = 15, y = 483) {
      let europe_small_map = [ 
        {'id': 'es_bcn', 'country': 'Spain', 'city': 'Barcelona',
          'connections': ['fr_par', 'uk_lnd', 'it_mil'],
          'img': 'dta/barcelona-px.png',
          'locations': [ 
            {'name': 'Park Güell', 'des': ['We saw you man wearing', 'a shirt.'], 'time': 1},
            {'name': 'Casa Milà', 'des': ['Your listened your subject', 'speaking with an Italian women.'], 'time': 2},
            {'name': 'Camp Nou', 'des': ['No, we cannot make an exception', 'with you and let you in', 'to meet Messi.'], 'time': 1},
          ]
        },
        {'id': 'fr_par', 'country': 'France', 'city': 'Paris',
          'connections': ['es_bcn', 'dk_bil', 'de_hbg'],
          'img': 'dta/paris-px.png',
          'locations': [ 
            {'name': 'Notre Dame Cathedral', 'des': ['Shush!', 'Keep silence!', 'This is a Cathedral!'], 'time': 1},
            {'name': 'Louvre Museum', 'des': ['We saw your target', 'with another man!', 'Both of them were', 'wearing blue jeans.'], 'time': 1},
            {'name': 'Montmartre', 'des': ['Your guy was here', 'buying a lot of paintings', ', one with a black bull in it.'], 'time': 2},
          ]
        },
        {'id': 'uk_lnd', 'country': 'United Kingdom', 'city': 'London',
          'connections': ['es_bcn', 'ie_dub', 'de_hbg'],
          'img': 'dta/london-px.png',
          'locations': [ 
            {'name': 'London Eye', 'des': ['The suspect was seen', 'with a man carrying a', 'flag with black, yellow, and', 'red colours.'], 'time': 1},
            {'name': 'Tower of London', 'des': ['The person you are', 'looking for was wearing', 'sunglasses'], 'time': 1},
            {'name': 'The Shard', 'des': ['This is an office building', 'we have not seen your subject.'], 'time': 1},
          ]
        },
        {'id': 'dk_bil', 'country': 'Denmark', 'city': 'Billund',
          'connections': ['fr_par', 'de_hbg'],
          'img': 'dta/billund-px.png',
          'locations': [ 
            {'name': 'Legoland Park', 'des': ['The person you are looking', 'for bought a lot of blue, ', 'white, and red blocks.'], 'time': 1},
            {'name': 'Kongernes Jelling', 'des': ['We known nothing about', 'your subject.'], 'time': 2},
            {'name': 'Grindsted Kirke', 'des': ['Yes, we say your man around here.'], 'time': 1},
          ]
        },
        {'id': 'de_hbg', 'country': 'Germany', 'city': 'Heidelberg',
          'connections': ['dk_bil', 'fr_par', 'uk_lnd'],
          'img': 'dta/heidelberg-px.png',
          'locations': [ 
            {'name': 'Heidelberg Castle', 'des': ['The subject you look', 'for was wearing red robes.'], 'time': 1},
            {'name': 'The Old Bridge', 'des': ['Your subject had a boarding', 'pass with a white cross on it.'], 'time': 1},
            {'name': 'European Molecular Biology Laboratory', 'des': ['We do science here', 'when no one is interrupting us.'], 'time': 3},
          ]
        },
        {'id': 'it_mil', 'country': 'Italy', 'city': 'Milan',
          'connections': ['es_bcn', 'gr_ath', 'hn_dbv'],
          'img': 'dta/milan-px.png',
          'locations': [ 
            {'name': 'Il Duomo', 'des': ['I do not remember the colours', 'but you man had a three-coloured-flag passport.'], 'time': 1},
            {'name': 'Galleria Vittorio Emanuele II', 'des': ['Yes! Your subject was here.', 'He really did not pay attention to the gallery.'], 'time': 1},
            {'name': 'Teatro alla Scala', 'des': ['Your subject was here,' , 'inappropriately wearing sport shoes'], 'time': 1},
          ]
        },
        {'id': 'gr_ath', 'country': 'Greece', 'city': 'Athens',
          'connections': ['hn_dbv', 'it_mil'],
          'img': 'dta/athenas-px.png',
          'locations': [ 
            {'name': 'The Acropolis', 'des': ['We known nothing about', 'your subject.'], 'time': 3},
            {'name': 'The Parthenon', 'des': ['I do not think I saw', 'the person you are looking for.'], 'time': 3},
            {'name': 'Temple of Olympian Zeus', 'des': ['No one matching your description', 'was here'], 'time': 3},
          ]
        },
        {'id': 'hn_dbv', 'country': 'Croatia', 'city': 'Dubrovnik',
          'connections': ['gr_ath', 'it_mil'],
          'img': 'dta/dubrovnik-px.png',
          'locations': [ 
            {'name': 'The Old City Walls', 'des': ['Yes, we saw you man!'], 'time': 1},
            {'name': 'Loggia Square', 'des': ['Your subject was here, yes.'], 'time': 1},
            {'name': 'The Island of Lokrum', 'des': ['The person you are', 'looking for visited this island.'], 'time': 3},
          ]
        },
        {'id': 'ie_dub', 'country': 'Ireland', 'city': 'Dublin',
          'connections': ['uk_lnd'],
          'img': 'dta/dublin-px.png',
          'locations': [ 
            {'name': 'Guinness Storehouse', 'des': ['If you are not buying', 'beer, stop disturbing the worked.'], 'time': 2},
            {'name': 'Kilmainham Gaol', 'des': ['I do not think I saw', 'the person you are looking for.'], 'time': 2},
            {'name': 'Trinity College', 'des': ['We known nothing about', 'your subject.'], 'time': 2},
          ]
        }
      ]

      let map = new Map(15, 483)
      for(let ii = 0; ii < europe_small_map.length; ii++) {
        map.addItem(europe_small_map[ii])
      }
      map.current = 'uk_lnd'
      map.create(x, y)
      return map
    }

    function createMainMenu(x = 10, y = 20) {
      let options = [{'text': 'Travel'}, {
        'text': 'Search', 'picture': ['#', 'G', 'G', '#', '#', '#', 'G', 'w', 'w', 'G', '#', '#', 'G', 'w', 'w', 'G', '#', '#', '#', 'G', 'G', 'b', '#', '#', '#', '#', '#', '#', 'b', '#', '#', '#', '#', '#', '#', 'b']}, 
        {'text': 'Data'}]
      options = options.map( (op) => new MenuOption(op.text, op.picture))
      return new Menu(x, y, options)  
    }

    function moveLocation(new_loc) {
      game_map.move(new_loc)
    }

    function showSearchOption(txt) {
      game_map.info_show = txt
    }
    
    /* ----------------------------------------------------------------- */
    let game_map = create_map()
    let time_traker = new TimeTraker(35, 30, 9, 25, 700)
    let main_menu = createMainMenu(375, 500)
    main_menu.setHorizontal()
    main_menu.showTitle()
    main_menu.addPulse(0, function() { game_map.toggleDrawTravel() })
    main_menu.addPulse(1, function() { game_map.toggleDrawSearch() })
    main_menu.addPulse(2, function() { console.log('DATA menu not available') })

    /* ----------------------------------------------------------------- */
    function game() {
      context.clearRect(0, 0, width, height);
      main_menu.draw(context)
      game_map.draw(context)
      game_map.drawLandscape(15, 75, context)
      time_traker.draw(game_map[game_map.current], context)
    }

    /* ----------------------------------------------------------------- */ 
    document.addEventListener("click", onClick, false);   
    function onClick(e) {
      let mX = event.pageX - canvas.offsetLeft
      let mY = event.pageY - canvas.offsetTop
      console.log('onClick: (', mX, ', ', mY, ')')
      main_menu.checkButtons(mX, mY, context)
      game_map.checkButtons(mX, mY, context)
    }

    /* ----------------------------------------------------------------- */ 
    setInterval(game, 15);
  </script>
</body>
</html>